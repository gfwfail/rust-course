# ğŸ‰ ç¬¬ 100 è¯¾ï¼šæ™ºèƒ½æŒ‡é’ˆå…¨è§ˆ â€” Boxã€Rcã€Arcã€RefCell

æ­å–œæˆ‘ä»¬æ¥åˆ°ç¬¬ 100 è¯¾ï¼ä»Šå¤©ç³»ç»Ÿè®²è§£ Rust çš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒä»¬æ˜¯å†…å­˜ç®¡ç†çš„æ ¸å¿ƒå·¥å…·ã€‚

---

## ğŸ“¦ ä»€ä¹ˆæ˜¯æ™ºèƒ½æŒ‡é’ˆï¼Ÿ

æ™ºèƒ½æŒ‡é’ˆæ˜¯ã€Œæ‹¥æœ‰æ‰€æœ‰æƒã€çš„æŒ‡é’ˆï¼Œä¸ä»…å­˜å‚¨åœ°å€ï¼Œè¿˜å¸¦æœ‰é¢å¤–åŠŸèƒ½ï¼ˆå¦‚è‡ªåŠ¨é‡Šæ”¾ã€å¼•ç”¨è®¡æ•°ï¼‰ã€‚

```rust
// æ™®é€šå¼•ç”¨ï¼šå€Ÿç”¨ï¼Œä¸æ‹¥æœ‰
let x = 5;
let r: &i32 = &x;  // åªæ˜¯å€Ÿç”¨

// æ™ºèƒ½æŒ‡é’ˆï¼šæ‹¥æœ‰æ•°æ®
let b: Box<i32> = Box::new(5);  // Box æ‹¥æœ‰è¿™ä¸ª 5
```

Rust æ ‡å‡†åº“çš„ä¸»è¦æ™ºèƒ½æŒ‡é’ˆï¼š

| ç±»å‹ | ç”¨é€” | çº¿ç¨‹å®‰å…¨ |
|------|------|----------|
| `Box<T>` | å †åˆ†é… | âœ… |
| `Rc<T>` | å¼•ç”¨è®¡æ•°ï¼ˆå•çº¿ç¨‹ï¼‰ | âŒ |
| `Arc<T>` | åŸå­å¼•ç”¨è®¡æ•°ï¼ˆå¤šçº¿ç¨‹ï¼‰ | âœ… |
| `RefCell<T>` | å†…éƒ¨å¯å˜æ€§ | âŒ |
| `Mutex<T>` | äº’æ–¥é” | âœ… |

---

## ğŸ Box â€” å †åˆ†é…

æœ€ç®€å•çš„æ™ºèƒ½æŒ‡é’ˆï¼ŒæŠŠæ•°æ®æ”¾åˆ°å †ä¸Šï¼š

```rust
// æ ˆä¸Šçš„æ•°æ®
let x = 5;  // åœ¨æ ˆä¸Š

// å †ä¸Šçš„æ•°æ®
let b = Box::new(5);  // 5 åœ¨å †ä¸Šï¼Œbï¼ˆæŒ‡é’ˆï¼‰åœ¨æ ˆä¸Š
println!("{}", b);    // è‡ªåŠ¨è§£å¼•ç”¨ï¼Œè¾“å‡º 5

// Box ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå †å†…å­˜è‡ªåŠ¨é‡Šæ”¾
```

### ä½¿ç”¨åœºæ™¯ 1ï¼šé€’å½’ç±»å‹

```rust
// âŒ ç¼–è¯‘é”™è¯¯ï¼šæ— é™å¤§å°
enum List {
    Cons(i32, List),  // List åŒ…å« List...
    Nil,
}

// âœ… ç”¨ Box æ‰“ç ´é€’å½’
enum List {
    Cons(i32, Box<List>),  // Box å¤§å°å›ºå®šï¼ˆä¸€ä¸ªæŒ‡é’ˆï¼‰
    Nil,
}

let list = List::Cons(1, 
    Box::new(List::Cons(2, 
        Box::new(List::Nil)
    ))
);
```

### ä½¿ç”¨åœºæ™¯ 2ï¼šå¤§æ•°æ®é¿å…æ‹·è´

```rust
struct HugeData {
    data: [u8; 1_000_000],  // 1MB
}

// âŒ ä¼ å€¼ä¼šæ‹·è´ 1MB
fn process(data: HugeData) { ... }

// âœ… ç”¨ Boxï¼Œåªä¼ é€’æŒ‡é’ˆï¼ˆ8 å­—èŠ‚ï¼‰
fn process(data: Box<HugeData>) { ... }
```

### ä½¿ç”¨åœºæ™¯ 3ï¼štrait å¯¹è±¡

```rust
trait Animal {
    fn speak(&self);
}

// dyn Animal å¤§å°ä¸ç¡®å®šï¼Œå¿…é¡»ç”¨æŒ‡é’ˆ
let animals: Vec<Box<dyn Animal>> = vec![
    Box::new(Dog),
    Box::new(Cat),
];
```

---

## ğŸ”— Rc â€” å¼•ç”¨è®¡æ•°ï¼ˆå•çº¿ç¨‹ï¼‰

`Rc`ï¼ˆReference Countedï¼‰å…è®¸å¤šä¸ªæ‰€æœ‰è€…ï¼š

```rust
use std::rc::Rc;

let a = Rc::new(String::from("hello"));
let b = Rc::clone(&a);  // å¼•ç”¨è®¡æ•° +1
let c = Rc::clone(&a);  // å¼•ç”¨è®¡æ•° +1

println!("å¼•ç”¨è®¡æ•°: {}", Rc::strong_count(&a));  // 3

// å¯ä»¥æœ‰å¤šä¸ªæ‰€æœ‰è€…
println!("{} {} {}", a, b, c);  // hello hello hello

// æ¯ä¸ª Rc ç¦»å¼€ä½œç”¨åŸŸï¼Œè®¡æ•° -1
// å½“è®¡æ•°å½’é›¶ï¼Œæ•°æ®è¢«é‡Šæ”¾
```

### å…¸å‹åœºæ™¯ï¼šå…±äº«æ•°æ®ç»“æ„

```rust
use std::rc::Rc;

//     a -> [3] -> [4] -> Nil
//            ^
//     b -----+
//            ^
//     c -----+

enum List {
    Cons(i32, Rc<List>),
    Nil,
}

use List::{Cons, Nil};

let tail = Rc::new(Cons(4, Rc::new(Nil)));
let shared = Rc::new(Cons(3, Rc::clone(&tail)));

let a = Cons(1, Rc::clone(&shared));
let b = Cons(2, Rc::clone(&shared));
// a å’Œ b å…±äº« shared éƒ¨åˆ†
```

### âš ï¸ Rc çš„é™åˆ¶

```rust
let a = Rc::new(5);

// âŒ Rc é»˜è®¤ä¸å¯å˜ï¼
*a = 10;  // ç¼–è¯‘é”™è¯¯

// âŒ ä¸èƒ½è·¨çº¿ç¨‹
std::thread::spawn(move || {
    println!("{}", a);  // ç¼–è¯‘é”™è¯¯ï¼
});
```

---

## âš›ï¸ Arc â€” åŸå­å¼•ç”¨è®¡æ•°ï¼ˆå¤šçº¿ç¨‹ï¼‰

`Arc`ï¼ˆAtomic Reference Countedï¼‰æ˜¯çº¿ç¨‹å®‰å…¨çš„ `Rc`ï¼š

```rust
use std::sync::Arc;
use std::thread;

let data = Arc::new(vec![1, 2, 3]);

let handles: Vec<_> = (0..3).map(|i| {
    let data = Arc::clone(&data);  // åŸå­æ“ä½œ +1
    thread::spawn(move || {
        println!("çº¿ç¨‹ {} çœ‹åˆ°: {:?}", i, data);
    })
}).collect();

for h in handles {
    h.join().unwrap();
}
```

### Arc vs Rc

| ç‰¹æ€§ | Rc | Arc |
|------|-----|-----|
| çº¿ç¨‹å®‰å…¨ | âŒ | âœ… |
| æ€§èƒ½ | æ›´å¿« | ç¨æ…¢ï¼ˆåŸå­æ“ä½œï¼‰ |
| ä½¿ç”¨åœºæ™¯ | å•çº¿ç¨‹ | å¤šçº¿ç¨‹ |

**åŸåˆ™**ï¼šå•çº¿ç¨‹ç”¨ `Rc`ï¼Œå¤šçº¿ç¨‹ç”¨ `Arc`

---

## ğŸ”“ RefCell â€” å†…éƒ¨å¯å˜æ€§

Rust çš„å€Ÿç”¨è§„åˆ™ï¼šè¦ä¹ˆä¸€ä¸ªå¯å˜å¼•ç”¨ï¼Œè¦ä¹ˆå¤šä¸ªä¸å¯å˜å¼•ç”¨ã€‚
`RefCell` æŠŠè¿™ä¸ªæ£€æŸ¥ä»ç¼–è¯‘æœŸç§»åˆ°è¿è¡Œæ—¶ï¼š

```rust
use std::cell::RefCell;

let data = RefCell::new(5);

// è¿è¡Œæ—¶å€Ÿç”¨æ£€æŸ¥
let r1 = data.borrow();      // ä¸å¯å˜å€Ÿç”¨
let r2 = data.borrow();      // å¯ä»¥å†å€Ÿç”¨
println!("{} {}", r1, r2);

drop(r1);
drop(r2);

// å¯å˜å€Ÿç”¨
*data.borrow_mut() = 10;
println!("{}", data.borrow());  // 10

// âš ï¸ è¿è¡Œæ—¶ panicï¼
let r1 = data.borrow();
let r2 = data.borrow_mut();  // panic! å·²æœ‰ä¸å¯å˜å€Ÿç”¨
```

### Rc + RefCell = å¤šæ‰€æœ‰è€…å¯å˜

```rust
use std::rc::Rc;
use std::cell::RefCell;

let shared = Rc::new(RefCell::new(vec![1, 2, 3]));

let a = Rc::clone(&shared);
let b = Rc::clone(&shared);

// ä»»ä½•æŒæœ‰è€…éƒ½èƒ½ä¿®æ”¹ï¼
a.borrow_mut().push(4);
b.borrow_mut().push(5);

println!("{:?}", shared.borrow());  // [1, 2, 3, 4, 5]
```

è¿™åœ¨ PHP é‡Œå¾ˆè‡ªç„¶ï¼ˆå¯¹è±¡é»˜è®¤å…±äº«å¼•ç”¨ï¼‰ï¼Œä½† Rust éœ€è¦æ˜¾å¼ç»„åˆã€‚

---

## ğŸ§© ç»„åˆä½¿ç”¨é€ŸæŸ¥

| éœ€æ±‚ | æ–¹æ¡ˆ |
|------|------|
| å•æ‰€æœ‰è€…ï¼Œå †åˆ†é… | `Box<T>` |
| å¤šæ‰€æœ‰è€…ï¼Œå•çº¿ç¨‹ï¼Œä¸å¯å˜ | `Rc<T>` |
| å¤šæ‰€æœ‰è€…ï¼Œå•çº¿ç¨‹ï¼Œå¯å˜ | `Rc<RefCell<T>>` |
| å¤šæ‰€æœ‰è€…ï¼Œå¤šçº¿ç¨‹ï¼Œä¸å¯å˜ | `Arc<T>` |
| å¤šæ‰€æœ‰è€…ï¼Œå¤šçº¿ç¨‹ï¼Œå¯å˜ | `Arc<Mutex<T>>` |

---

## ğŸ“ è¯¾åæ€è€ƒ

1. ä¸ºä»€ä¹ˆ `Rc` ä¸èƒ½è·¨çº¿ç¨‹ï¼Œè€Œ `Arc` å¯ä»¥ï¼Ÿ
2. `RefCell` çš„å€Ÿç”¨æ£€æŸ¥åœ¨è¿è¡Œæ—¶ï¼Œå¦‚æœè¿åè§„åˆ™ä¼šæ€æ ·ï¼Ÿ
3. å¦‚ä½•å®ç°ä¸€ä¸ªç®€å•çš„è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆå¤šä¸ªè§‚å¯Ÿè€…å…±äº«è®¢é˜…åŒä¸€ä¸ªä¸»é¢˜ï¼‰ï¼Ÿ

---

*ğŸ‰ ç¬¬ 100 è¯¾å®Œ â€” æˆ‘ä»¬å·²ç»èµ°è¿‡äº† 100 è¯¾çš„ Rust å­¦ä¹ ä¹‹æ—…ï¼*
