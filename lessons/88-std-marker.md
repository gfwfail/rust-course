# ç¬¬ 88 è¯¾ï¼šstd::marker â€” Marker Traits çš„å¥¥ç§˜

> æ—¥æœŸï¼š2026-02-23  
> ä¸»é¢˜ï¼šSend, Sync, Sized, Unpin â€” é›¶å¤§å°çš„ç±»å‹å®ˆæŠ¤è€…

---

## ğŸ“Œ ä»€ä¹ˆæ˜¯ Marker Traitï¼Ÿ

**Marker trait** æ˜¯ä¸€ç§"ç©º"çš„ traitâ€”â€”å®ƒæ²¡æœ‰ä»»ä½•æ–¹æ³•ï¼Œåªæ˜¯ç»™ç±»å‹æ‰“ä¸ª"æ ‡ç­¾"ï¼š

```rust
// æ ‡å‡†åº“å®šä¹‰
pub trait Copy: Clone { }  // ç©ºçš„ï¼
pub unsafe auto trait Send { }  // ä¹Ÿæ˜¯ç©ºçš„ï¼
pub unsafe auto trait Sync { }  // åŒæ ·ï¼
pub trait Sized { }  // è¿˜æ˜¯ç©ºçš„ï¼
```

è¿™äº› trait ä¸å®šä¹‰è¡Œä¸ºï¼Œè€Œæ˜¯å‘ç¼–è¯‘å™¨**ä¼ é€’ä¿¡æ¯**ï¼š

- `Copy` â†’ "æˆ‘å¯ä»¥æŒ‰ä½å¤åˆ¶"
- `Send` â†’ "æˆ‘å¯ä»¥è·¨çº¿ç¨‹ç§»åŠ¨"
- `Sync` â†’ "æˆ‘å¯ä»¥è·¨çº¿ç¨‹å…±äº«"
- `Sized` â†’ "æˆ‘çš„å¤§å°åœ¨ç¼–è¯‘æœŸå·²çŸ¥"

---

## ğŸ”§ std::marker æ¨¡å—åŒ…å«ä»€ä¹ˆï¼Ÿ

```rust
use std::marker::{
    PhantomData,      // å¹½çµæ•°æ®ï¼ˆç¬¬73è¯¾è®²è¿‡ï¼‰
    PhantomPinned,    // ç¦æ­¢ Unpin çš„æ ‡è®°
    // ä»¥ä¸‹æ˜¯ auto traitï¼Œé€šå¸¸é€šè¿‡ prelude ä½¿ç”¨
    // Send, Sync, Sized, Unpin, Copy
};
```

---

## ğŸ“¦ Sized â€” ç¼–è¯‘æœŸå¤§å°å·²çŸ¥

### é»˜è®¤ç»‘å®š

åœ¨ Rust ä¸­ï¼Œ**æ‰€æœ‰æ³›å‹å‚æ•°é»˜è®¤æœ‰ `Sized` çº¦æŸ**ï¼š

```rust
fn foo<T>(t: T) { }
// ç­‰ä»·äº
fn foo<T: Sized>(t: T) { }
```

### ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ï¼Ÿ

å› ä¸ºç¼–è¯‘å™¨éœ€è¦çŸ¥é“åœ¨æ ˆä¸Šåˆ†é…å¤šå°‘ç©ºé—´ï¼š

```rust
let x: i32 = 42;    // ç¼–è¯‘å™¨çŸ¥é“æ˜¯ 4 å­—èŠ‚
let y: String = ...; // ç¼–è¯‘å™¨çŸ¥é“æ˜¯ 24 å­—èŠ‚ï¼ˆæŒ‡é’ˆ+é•¿åº¦+å®¹é‡ï¼‰
```

### åŠ¨æ€å¤§å°ç±»å‹ (DST)

æœ‰äº›ç±»å‹çš„å¤§å°åœ¨ç¼–è¯‘æœŸ**ä¸çŸ¥é“**ï¼š

```rust
// str æ˜¯ DST â€” å­—ç¬¦ä¸²åˆ‡ç‰‡ï¼Œé•¿åº¦ä¸å›ºå®š
// [T] æ˜¯ DST â€” åˆ‡ç‰‡ï¼Œé•¿åº¦ä¸å›ºå®š  
// dyn Trait æ˜¯ DST â€” trait å¯¹è±¡ï¼Œå…·ä½“ç±»å‹æœªçŸ¥
```

è¿™äº›ç±»å‹ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œå¿…é¡»æ”¾åœ¨å¼•ç”¨æˆ–æ™ºèƒ½æŒ‡é’ˆåé¢ï¼š

```rust
// let s: str = ...;     // âŒ ç¼–è¯‘é”™è¯¯ï¼šå¤§å°æœªçŸ¥
let s: &str = "hello";   // âœ… &str å¤§å°å·²çŸ¥ï¼ˆ16å­—èŠ‚=æŒ‡é’ˆ+é•¿åº¦ï¼‰

// let v: [i32] = ...;   // âŒ ç¼–è¯‘é”™è¯¯
let v: &[i32] = &[1,2,3]; // âœ… èƒ–æŒ‡é’ˆ
```

### ?Sized â€” è§£é™¤çº¦æŸ

æœ‰æ—¶æˆ‘ä»¬æƒ³æ¥å— DSTï¼š

```rust
// åªèƒ½æ¥å— Sized ç±»å‹
fn print_size<T>(t: &T) {
    println!("{}", std::mem::size_of::<T>());
}

// å¯ä»¥æ¥å—ä»»ä½•ç±»å‹ï¼ŒåŒ…æ‹¬ DST
fn print_ref<T: ?Sized>(t: &T) {
    // è¿™é‡Œä¸èƒ½è°ƒç”¨ size_of::<T>()
    // å› ä¸º T å¯èƒ½æ˜¯ DST
}
```

`Box<T>` çš„å®šä¹‰å°±ç”¨äº† `?Sized`ï¼š

```rust
pub struct Box<T: ?Sized> { ... }

// æ‰€ä»¥è¿™æ˜¯åˆæ³•çš„ï¼š
let b: Box<dyn Debug> = Box::new(42);
```

---

## ğŸš€ Send â€” è·¨çº¿ç¨‹ç§»åŠ¨å®‰å…¨

```rust
pub unsafe auto trait Send { }
```

### å«ä¹‰

å¦‚æœç±»å‹ `T` å®ç°äº† `Send`ï¼Œæ„å‘³ç€ `T` ç±»å‹çš„å€¼å¯ä»¥**å®‰å…¨åœ°ç§»åŠ¨åˆ°å¦ä¸€ä¸ªçº¿ç¨‹**ã€‚

### å¤§éƒ¨åˆ†ç±»å‹éƒ½æ˜¯ Send

```rust
// âœ… Send çš„ç±»å‹
i32, String, Vec<T>, Box<T>, Arc<T>

// âŒ ä¸æ˜¯ Send çš„ç±»å‹
Rc<T>      // å¼•ç”¨è®¡æ•°ä¸æ˜¯åŸå­çš„
*const T   // è£¸æŒ‡é’ˆä¸ä¿è¯çº¿ç¨‹å®‰å…¨
Cell<T>    // å†…éƒ¨å¯å˜æ€§ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
```

### ä¸ºä»€ä¹ˆ Rc ä¸æ˜¯ Sendï¼Ÿ

```rust
use std::rc::Rc;
use std::thread;

let rc = Rc::new(42);
thread::spawn(move || {
    println!("{}", rc);  // âŒ ç¼–è¯‘é”™è¯¯ï¼
});
// Rc çš„å¼•ç”¨è®¡æ•°ä¸æ˜¯åŸå­æ“ä½œ
// å¦‚æœå¤šçº¿ç¨‹åŒæ—¶æ“ä½œï¼Œä¼šå‡ºç°æ•°æ®ç«äº‰
```

æ­£ç¡®åšæ³•æ˜¯ç”¨ `Arc`ï¼ˆåŸå­å¼•ç”¨è®¡æ•°ï¼‰ï¼š

```rust
use std::sync::Arc;

let arc = Arc::new(42);
thread::spawn(move || {
    println!("{}", arc);  // âœ…
});
```

---

## ğŸ”„ Sync â€” è·¨çº¿ç¨‹å…±äº«å®‰å…¨

```rust
pub unsafe auto trait Sync { }
```

### å«ä¹‰

å¦‚æœç±»å‹ `T` å®ç°äº† `Sync`ï¼Œæ„å‘³ç€ `&T` å¯ä»¥**å®‰å…¨åœ°åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«**ã€‚

### æ ¸å¿ƒå…³ç³»

```
T: Sync  âŸº  &T: Send
```

å¦‚æœä½ èƒ½å®‰å…¨åœ°å…±äº« `&T` åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼ˆ`&T: Send`ï¼‰ï¼Œé‚£ `T` å°±æ˜¯ `Sync` çš„ã€‚

### ä¾‹å­

```rust
// âœ… Sync çš„ç±»å‹
i32, String, Vec<T>, Mutex<T>, RwLock<T>, Arc<T>

// âŒ ä¸æ˜¯ Sync çš„ç±»å‹
Cell<T>     // å†…éƒ¨å¯å˜æ€§ï¼Œæ— é”
RefCell<T>  // å†…éƒ¨å¯å˜æ€§ï¼Œæ— é”
Rc<T>       // å¼•ç”¨è®¡æ•°éåŸå­
```

### ä¸ºä»€ä¹ˆ Cell ä¸æ˜¯ Syncï¼Ÿ

```rust
use std::cell::Cell;

let cell = Cell::new(0);
// å‡è®¾èƒ½è·¨çº¿ç¨‹å…±äº«...
// çº¿ç¨‹1: cell.set(1)
// çº¿ç¨‹2: cell.set(2)
// ğŸ’¥ æ•°æ®ç«äº‰ï¼Cell çš„ set æ²¡æœ‰åŠ é”
```

---

## ğŸ“Š Send å’Œ Sync é€ŸæŸ¥è¡¨

| ç±»å‹ | Send | Sync | åŸå›  |
|------|------|------|------|
| `i32` | âœ… | âœ… | ç®€å•å€¼ç±»å‹ |
| `String` | âœ… | âœ… | æœ‰æ‰€æœ‰æƒ |
| `&T` (T: Sync) | âœ… | âœ… | åªè¯»å…±äº« |
| `&mut T` | âœ… | âŒ | ç‹¬å è®¿é—®ï¼Œåªèƒ½ Send |
| `Rc<T>` | âŒ | âŒ | éåŸå­å¼•ç”¨è®¡æ•° |
| `Arc<T>` | âœ… | âœ… | åŸå­å¼•ç”¨è®¡æ•° |
| `Mutex<T>` | âœ… | âœ… | åŠ é”ä¿æŠ¤ |
| `Cell<T>` | âœ… | âŒ | å¯ä»¥ç§»åŠ¨ï¼Œä½†ä¸èƒ½å…±äº« |
| `RefCell<T>` | âœ… | âŒ | åŒä¸Š |
| `*const T` | âŒ | âŒ | è£¸æŒ‡é’ˆï¼Œå•¥ä¹Ÿä¸ä¿è¯ |

---

## ğŸ“Œ Unpin â€” å¯ä»¥å®‰å…¨ç§»åŠ¨

```rust
pub auto trait Unpin { }
```

### èƒŒæ™¯ï¼šPin çš„æ„ä¹‰

æŸäº›ç±»å‹ï¼ˆå¦‚è‡ªå¼•ç”¨ç»“æ„ä½“ã€async çŠ¶æ€æœºï¼‰ä¸€æ—¦è¢«"é’‰ä½"ï¼ˆpinnedï¼‰ï¼Œå°±ä¸èƒ½ç§»åŠ¨ã€‚

### Unpin çš„å«ä¹‰

- `T: Unpin` â†’ `Pin<&mut T>` ç­‰ä»·äº `&mut T`ï¼Œå¯ä»¥éšä¾¿ç§»åŠ¨
- `T: !Unpin` â†’ ä¸€æ—¦è¢« Pinï¼Œå°±çœŸçš„ä¸èƒ½ç§»åŠ¨äº†

**å¤§éƒ¨åˆ†ç±»å‹éƒ½æ˜¯ Unpin**ï¼Œåªæœ‰ async å—ç”Ÿæˆçš„ Future ç­‰ç‰¹æ®Šç±»å‹ä¸æ˜¯ã€‚

### å®æˆ˜ä¸­

```rust
// å¤§éƒ¨åˆ†æƒ…å†µä¸ç”¨å…³å¿ƒ Unpin
// åªæœ‰å†™ async åº•å±‚ä»£ç æˆ–è‡ªå¼•ç”¨ç»“æ„ä½“æ—¶æ‰éœ€è¦è€ƒè™‘

use std::marker::PhantomPinned;

struct SelfRef {
    data: String,
    ptr: *const String,
    _pin: PhantomPinned,  // ç¦æ­¢ Unpin
}
```

---

## ğŸ› ï¸ auto trait â€” è‡ªåŠ¨å®ç°

`Send`, `Sync`, `Unpin` éƒ½æ˜¯ **auto trait**ï¼š

```rust
// å¦‚æœç»“æ„ä½“æ‰€æœ‰å­—æ®µéƒ½æ˜¯ Sendï¼Œé‚£ç»“æ„ä½“è‡ªåŠ¨æ˜¯ Send
struct MyStruct {
    a: i32,      // Send
    b: String,   // Send
}
// MyStruct è‡ªåŠ¨å®ç° Send

struct NotSend {
    a: i32,
    b: Rc<i32>,  // ä¸æ˜¯ Send
}
// NotSend è‡ªåŠ¨ä¸å®ç° Send
```

### æ‰‹åŠ¨å®ç°ï¼ˆunsafeï¼ï¼‰

```rust
struct MyType(*mut u8);

// å‘Šè¯‰ç¼–è¯‘å™¨ï¼šæˆ‘ä¿è¯è¿™æ˜¯å®‰å…¨çš„
unsafe impl Send for MyType {}
unsafe impl Sync for MyType {}
```

âš ï¸ **é™¤éä½  100% ç¡®å®šï¼Œå¦åˆ™ä¸è¦è¿™ä¹ˆåšï¼**

---

## ğŸ“ PHP/Laravel å¯¹æ¯”

```php
// PHP æ²¡æœ‰è¿™äº›æ¦‚å¿µï¼Œå› ä¸º PHP-FPM æ˜¯å•è¿›ç¨‹æ¨¡å‹

// æœ€æ¥è¿‘çš„ç±»æ¯”ï¼š
// Sized â†’ PHP æ‰€æœ‰å˜é‡éƒ½æ˜¯"åŠ¨æ€å¤§å°"çš„
// Send/Sync â†’ Laravel Queue åºåˆ—åŒ–è¦æ±‚ç±»ä¼¼ï¼ˆèƒ½ä¸èƒ½åºåˆ—åŒ–ï¼Ÿï¼‰
//           â†’ Swoole/RoadRunner é‡Œæœ‰ç±»ä¼¼çš„çº¿ç¨‹å®‰å…¨é—®é¢˜
```

---

## ğŸ“ å°æµ‹éªŒ

```rust
use std::rc::Rc;
use std::sync::Arc;
use std::cell::RefCell;

// é—®é¢˜ï¼šä»¥ä¸‹å“ªäº›ç±»å‹å¯ä»¥å®‰å…¨åœ°è·¨çº¿ç¨‹ä¼ é€’ï¼Ÿ

type A = Arc<Vec<i32>>;         // âœ… Send + Sync
type B = Rc<i32>;               // âŒ é Send
type C = Arc<RefCell<i32>>;     // âœ… Sendï¼Œä½† âŒ é Sync
type D = Arc<Mutex<i32>>;       // âœ… Send + Sync
type E = Box<dyn Fn() + Send>;  // âœ… æ˜¾å¼è¦æ±‚ Send
```

---

## ğŸ”‘ æ€»ç»“

| Marker Trait | å«ä¹‰ | é»˜è®¤ |
|--------------|------|------|
| `Sized` | ç¼–è¯‘æœŸå¤§å°å·²çŸ¥ | æ‰€æœ‰æ³›å‹é»˜è®¤æœ‰ |
| `Send` | å¯ä»¥è·¨çº¿ç¨‹ç§»åŠ¨ | å¤§éƒ¨åˆ†ç±»å‹è‡ªåŠ¨æœ‰ |
| `Sync` | å¯ä»¥è·¨çº¿ç¨‹å…±äº« | å¤§éƒ¨åˆ†ç±»å‹è‡ªåŠ¨æœ‰ |
| `Unpin` | è¢« Pin åä»å¯ç§»åŠ¨ | å¤§éƒ¨åˆ†ç±»å‹è‡ªåŠ¨æœ‰ |
| `Copy` | å¯æŒ‰ä½å¤åˆ¶ | éœ€è¦æ‰‹åŠ¨ derive |

**å…³é”®ç†è§£**ï¼šè¿™äº› trait æ²¡æœ‰æ–¹æ³•ï¼Œå®ƒä»¬æ˜¯**ç¼–è¯‘å™¨çš„æç¤º**ï¼Œè®©ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸå°±èƒ½é˜»æ­¢çº¿ç¨‹ä¸å®‰å…¨çš„ä»£ç ï¼

---

**ä¸‹èŠ‚é¢„å‘Š**: `std::any` â€” Any trait ä¸è¿è¡Œæ—¶ç±»å‹ä¿¡æ¯ ğŸ”
