# ç¬¬3è¯¾ï¼šæ‰€æœ‰æƒ Ownership â€”â€” Rust çš„çµé­‚

## å…ˆè¯´ä¸ºä»€ä¹ˆè¦æœ‰è¿™çŽ©æ„

ä½ å†™ JS/PHP çš„æ—¶å€™ï¼š
- JSï¼šåžƒåœ¾å›žæ”¶å™¨å¸®ä½ ç®¡å†…å­˜ï¼Œä½†æœ‰ GC åœé¡¿
- PHPï¼šå¼•ç”¨è®¡æ•° + copy-on-writeï¼Œä¹Ÿæ˜¯è‡ªåŠ¨çš„

C/C++ï¼š
- æ‰‹åŠ¨ malloc/freeï¼Œå¿˜äº†å°±å†…å­˜æ³„æ¼ï¼Œå¤š free ä¸€æ¬¡å°±å´©æºƒ

**Rust çš„é‡Žå¿ƒ**ï¼šæ—¢ä¸è¦ GCï¼Œä¹Ÿä¸è¦æ‰‹åŠ¨ç®¡ç†ï¼Œè®©**ç¼–è¯‘å™¨**åœ¨ç¼–è¯‘æ—¶å°±æžå®šå†…å­˜é—®é¢˜ã€‚

æ€Žä¹ˆåšåˆ°çš„ï¼Ÿâ€”â€” æ‰€æœ‰æƒè§„åˆ™ã€‚

## ä¸‰æ¡é“å¾‹

1. **æ¯ä¸ªå€¼æœ‰ä¸”åªæœ‰ä¸€ä¸ª ownerï¼ˆæ‰€æœ‰è€…ï¼‰**
2. **owner ç¦»å¼€ä½œç”¨åŸŸï¼Œå€¼è‡ªåŠ¨é”€æ¯**
3. **å€¼å¯ä»¥ moveï¼ˆè½¬ç§»ï¼‰æˆ– borrowï¼ˆå€Ÿç”¨ï¼‰ï¼Œä½†ä¸èƒ½åŒæ—¶ä¹±æ¥**

## Moveï¼ˆè½¬ç§»ï¼‰â€”â€” Web ç¨‹åºå‘˜æœ€æ‡µçš„æ¦‚å¿µ

```rust
fn main() {
    let s1 = String::from("hello");
    let s2 = s1;  // s1 çš„æ‰€æœ‰æƒ move ç»™äº† s2
    
    println!("{}", s1);  // âŒ ç¼–è¯‘é”™è¯¯ï¼s1 å·²ç»æ²¡äº†
}
```

**ä¸ºä»€ä¹ˆï¼Ÿ**

`String` åœ¨å †ä¸Šåˆ†é…å†…å­˜ã€‚å¦‚æžœ s1 å’Œ s2 éƒ½æŒ‡å‘åŒä¸€å—å†…å­˜ï¼š
- è°æ¥é‡Šæ”¾ï¼Ÿ
- é‡Šæ”¾ä¸¤æ¬¡å°±å´©äº†ï¼ˆdouble freeï¼‰

Rust çš„è§£æ³•ï¼š**ç›´æŽ¥è®© s1 å¤±æ•ˆ**ï¼Œä»Žæ ¹æºæœç»é—®é¢˜ã€‚

**å¯¹æ¯” JSï¼š**
```javascript
let s1 = "hello";
let s2 = s1;
console.log(s1);  // OKï¼Œå› ä¸º JS æœ‰ GC å¸®ä½ æ•°å¼•ç”¨
```

## å‡½æ•°è°ƒç”¨ä¹Ÿä¼š Move

```rust
fn take_ownership(s: String) {
    println!("{}", s);
}  // s åœ¨è¿™é‡Œè¢«é”€æ¯

fn main() {
    let my_string = String::from("hello");
    take_ownership(my_string);  // æ‰€æœ‰æƒ move è¿›å‡½æ•°äº†
    
    println!("{}", my_string);  // âŒ ç¼–è¯‘é”™è¯¯ï¼æ²¡äº†
}
```

è¿™åœ¨ JS/PHP é‡Œä¸å¯èƒ½å‘ç”Ÿå§ï¼Ÿä¼ å‚æ•°è¿›åŽ»ï¼ŒåŽŸæ¥çš„å˜é‡è¿˜èƒ½ç”¨ã€‚

## Borrowï¼ˆå€Ÿç”¨ï¼‰â€”â€” ä¸æƒ³ Move æ€Žä¹ˆåŠžï¼Ÿ

```rust
fn print_string(s: &String) {  // æ³¨æ„ &ï¼Œè¡¨ç¤ºå€Ÿç”¨
    println!("{}", s);
}  // å€Ÿç”¨ç»“æŸï¼Œä½†åŽŸå€¼ä¸é”€æ¯

fn main() {
    let my_string = String::from("hello");
    print_string(&my_string);  // å€Ÿç»™å‡½æ•°ç”¨ä¸€ä¸‹
    
    println!("{}", my_string);  // âœ… è¿˜èƒ½ç”¨ï¼
}
```

`&` å°±åƒæ˜¯è¯´ï¼š**å€Ÿä½ çœ‹çœ‹ï¼Œä½†ä¸œè¥¿è¿˜æ˜¯æˆ‘çš„**ã€‚

## å¯å˜å€Ÿç”¨ &mut

```rust
fn add_world(s: &mut String) {
    s.push_str(", world!");
}

fn main() {
    let mut my_string = String::from("hello");
    add_world(&mut my_string);
    println!("{}", my_string);  // "hello, world!"
}
```

æ³¨æ„è¦åŒæ—¶æ»¡è¶³ï¼š
1. åŽŸå˜é‡å£°æ˜Ž `mut`
2. ä¼ å‚ç”¨ `&mut`

## å€Ÿç”¨çš„è§„åˆ™ï¼ˆé˜²æ­¢æ•°æ®ç«žäº‰ï¼‰

åŒä¸€æ—¶é—´ï¼Œä½ åªèƒ½æœ‰ï¼š
- **å¤šä¸ªä¸å¯å˜å¼•ç”¨ `&T`**ï¼ˆå¤§å®¶éƒ½åªè¯»ï¼Œæ²¡é—®é¢˜ï¼‰
- **æˆ–ä¸€ä¸ªå¯å˜å¼•ç”¨ `&mut T`**ï¼ˆåªæœ‰ä¸€ä¸ªäººèƒ½å†™ï¼‰
- **ä¸èƒ½åŒæ—¶æœ‰ï¼**

```rust
let mut s = String::from("hello");

let r1 = &s;      // âœ…
let r2 = &s;      // âœ… å¤šä¸ªåªè¯» OK
let r3 = &mut s;  // âŒ ç¼–è¯‘é”™è¯¯ï¼å·²ç»æœ‰åªè¯»å¼•ç”¨äº†

println!("{}, {}", r1, r2);
```

**ä¸ºä»€ä¹ˆè¿™ä¹ˆä¸¥æ ¼ï¼Ÿ**

æƒ³è±¡å¤šçº¿ç¨‹åœºæ™¯ï¼š
- çº¿ç¨‹ A åœ¨è¯»
- çº¿ç¨‹ B åŒæ—¶åœ¨å†™
- ðŸ’¥ æ•°æ®ç«žäº‰ï¼Œbug éš¾æŸ¥

Rust åœ¨**ç¼–è¯‘æœŸ**å°±ä¸è®©ä½ è¿™ä¹ˆå¹²ã€‚

## å®žæˆ˜ï¼šä»€ä¹ˆæ—¶å€™ Moveï¼Œä»€ä¹ˆæ—¶å€™ Borrowï¼Ÿ

| åœºæ™¯ | ç”¨ä»€ä¹ˆ |
|-----|--------|
| å‡½æ•°åªéœ€è¦è¯»æ•°æ® | `&T`ï¼ˆä¸å¯å˜å€Ÿç”¨ï¼‰ |
| å‡½æ•°è¦ä¿®æ”¹æ•°æ® | `&mut T`ï¼ˆå¯å˜å€Ÿç”¨ï¼‰ |
| å‡½æ•°è¦"åƒæŽ‰"æ•°æ®ï¼ˆæ¯”å¦‚å­˜åˆ°æŸä¸ªç»“æž„é‡Œï¼‰ | ç›´æŽ¥ä¼  `T`ï¼ˆmoveï¼‰ |
| å°æ•°æ®ï¼ˆi32, bool ç­‰ï¼‰ | éšä¾¿ï¼Œå®ƒä»¬ä¼š Copy ä¸ä¼š Move |

```rust
// åªè¯»ï¼šå€Ÿç”¨
fn get_length(s: &String) -> usize {
    s.len()
}

// è¦æ”¹ï¼šå¯å˜å€Ÿç”¨
fn make_uppercase(s: &mut String) {
    *s = s.to_uppercase();
}

// è¦å­˜èµ·æ¥ï¼šmove
struct Container {
    data: String,
}
fn store(s: String) -> Container {
    Container { data: s }  // s è¢« move è¿› Container
}
```

---

**ä¸‹èŠ‚è¯¾**ï¼šç”Ÿå‘½å‘¨æœŸ Lifetime
